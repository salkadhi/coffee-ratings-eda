---
title: "Coffee Ratings EDA"
author: "Sultan Alkadhi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
#load libraries and dataset
library(tidyverse)
library(viridis)
coffee_ratings <- read_csv(here("data/coffee_ratings.csv"))
```

Check data cleanliness
```{r}
(na_count <-sapply(coffee_ratings, function(y) sum(length(which(is.na(y)))))) 
```

Check data types
```{r}
glimpse(coffee_ratings)
```

Proportions of coffee species
```{r}
table(coffee_ratings['species'])
```
Check altitude distributions
```{r}
altitudes <- c("altitude_low_meters",	"altitude_high_meters",	"altitude_mean_meters")
coffee_ratings %>%
  select(altitudes) %>%
  gather(na.rm = TRUE) %>%
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_density()
```
Chech out the extreme values
```{r}
sort(coffee_ratings$altitude_mean_meters, decreasing = TRUE) %>% head(10)
```

After removing erroneous values
```{r}
coffee_ratings %>%
  select(altitude_mean_meters) %>%
  filter(altitude_mean_meters<4300) %>% 
  gather(na.rm = TRUE) %>%
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_density()
```
Check distribution of grades
```{r}
grades <- c("aroma",	"flavor",	"aftertaste",	"acidity",	"body",	"balance",	"uniformity",	"clean_cup",	"sweetness",	"cupper_points",	"total_cup_points")

coffee_ratings %>%
  select(grades) %>% 
  gather() %>%
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_density()
```
Check total score stats
```{r}
summary(coffee_ratings$total_cup_points)
```
Chech out the extreme values
```{r}
sort(coffee_ratings$total_cup_points) %>% head(10)
```
Only one zero value

```{r}
coffee_ratings %>% 
  filter(total_cup_points == 0) %>% 
  select(grades)
```
Received zero on all measures

```{r}
coffee_ratings %>%
  filter(total_cup_points > 0) %>% 
  select(grades) %>%
  gather() %>%
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_density()
```
It's easy to score high on clean cup, uniformity, and sweetness?
"Uniformity refers to consistency of flavor of the different cups of the sample tasted."
"Clean Cup refers to a lack of interfering negative impressions from first ingestion to final aftertaste"
"Sweetness" no longer part of the CQI scale?
"Acidity is often described as "brightness" when favorable or "sour" when unfavorable. At its best, acidity contributes to a coffee's liveliness, sweetness, and fresh- fruit character and is almost immediately experienced and evaluated when the coffee is first slurped into the mouth"

Countries represented
```{r}
coffee_ratings %>% 
  count(country_of_origin, sort=TRUE) %>% 
  top_n(20) %>% 
  ggplot(aes(reorder(country_of_origin, n), (n)))+
  geom_col()+
  coord_flip()+
  ylab("Countries")+xlab("Count")
```
```{r}
coffee_ratings %>% 
  count(country_of_origin, sort=TRUE) %>% 
  top_n(12) %>% 
  select(country_of_origin) -> top12countries
```

Order countries by rating and highlight altitude
```{r}
coffee_ratings[coffee_ratings$country_of_origin %in% top12countries[["country_of_origin"]],] %>%
filter(total_cup_points > 0) %>%
mutate(country = fct_reorder(country_of_origin, total_cup_points, .fun = max)) %>%
filter(total_cup_points > 0, altitude_mean_meters <=3500) %>%
ggplot(aes(country, total_cup_points, color=altitude_mean_meters, )) + geom_point() + coord_flip() +scale_color_viridis(option = "D")

```

```{r}
#model total score vs different grades
for (i in grades){              
print(ggplot(coffee_ratings[coffee_ratings$total_cup_points>0,], aes_string("total_cup_points", i)) + geom_point() + geom_smooth(method = "lm", se = FALSE))}
```
